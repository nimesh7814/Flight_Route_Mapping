---
title: "Global Flight Route Density Mapping - Complete Beginner's Guide"
author: "Nimesh Akalanka (Enhanced for Beginners)"
format:
  html:
    toc: true
    toc-depth: 3
    toc-location: left
    code-fold: show
    code-tools: true
    theme: cosmo
    fig-width: 16
    fig-height: 10
    embed-resources: true
execute:
  warning: false
  message: false
---

## üéØ What You'll Create

By the end of this tutorial, you'll have a beautiful, professional map showing **where airplanes fly most frequently around the world**. Think of it like a heat map - brighter colors show busier flight routes!

**Perfect for**: Beginners in data visualization, geography students, aviation enthusiasts, or anyone wanting to learn R programming.

## üìã Overview

### What This Tutorial Does (In Simple Terms)

1. **Downloads real flight data** from the internet (airports and routes)
2. **Processes the data** to connect airports with flight paths
3. **Creates a hexagon grid** over the world map (like a honeycomb)
4. **Counts how many flights** pass through each hexagon
5. **Makes a colorful map** showing flight density

### Types of Routes We'll Create

**Straight Routes** üîπ: Direct lines between airports (like drawing with a ruler on a flat map)

**Curved Routes** üåê: Realistic paths following Earth's spherical surface (how planes actually fly!)

::: {.callout-note icon="üí°"}
## Why Curved Routes Matter
Imagine you're flying from New York to Tokyo. On a flat map, the shortest path looks like it goes straight across the Pacific Ocean. But Earth is round! The actual shortest path curves up through Alaska. That's what geodetic (curved) routes show.
:::

---

## üõ†Ô∏è Prerequisites

### What is R?

**R** is a free programming language designed for statistics and data visualization. Think of it as Microsoft Excel on steroids - it can handle millions of data points and create professional visualizations.

### What You Need to Install

1. **R** (the programming language): Download from [r-project.org](https://www.r-project.org/)
2. **RStudio** (makes R easier to use): Download from [posit.co](https://posit.co/download/rstudio-desktop/)

### Install Required R Packages

Run this code **once** to install everything:

```{r}
#| label: install-packages
#| eval: false

# Install all required packages
install.packages(c("readr", "dplyr", "stringr", "sf", "ggplot2", "viridis", "scales", "rnaturalearth", "rnaturalearthdata","geosphere", "tmap"
))
```

::: {.callout-tip icon="‚è±Ô∏è"}
## Installation Time
This may take 5-10 minutes depending on your internet speed. Be patient!
:::

### Load Libraries

After installing packages once, you need to "load" them each time you start R:

```{r}
# Load all libraries we'll use
library(readr)       
library(dplyr)       
library(stringr)   
library(sf)        
library(ggplot2)     
library(viridis)  
library(scales)     
library(rnaturalearth)
library(geosphere)    
library(tmap)    

cat("‚úì All libraries loaded successfully!\n")
```

---

## üìÇ Step 1: Download and Prepare Airport Data

### Create Folder Structure

```{r}
# Create two folders: one for outputs, one for raw data
folders <- c("output", "data")
sapply(folders, dir.create, showWarnings = FALSE, recursive = TRUE)

cat("‚úì Folders created successfully!\n")
```

### Download Airport Data

```{r}
# Check if we already have the airports file
if (!file.exists("data/airports.dat")) {
  cat("üì• Downloading airports.dat...\n")

  download.file(
    url = "https://raw.githubusercontent.com/jpatokal/openflights/master/data/airports.dat",
    destfile = "data/airports.dat",
    mode = "wb"
    )
  cat("‚úì Airports downloaded!\n")
} else {
  cat("‚úì Airports file already exists. Skipping download.\n")
}
```

### Download Routes Data

```{r}
# Check if we already have the routes file
if (!file.exists("data/routes.dat")) {
  cat("üì• Downloading routes.dat...\n")
  
  download.file(
    url = "https://raw.githubusercontent.com/jpatokal/openflights/master/data/routes.dat",
    destfile = "data/routes.dat",
    mode = "wb"
  )
  cat("‚úì Routes downloaded!\n")
} else {
  cat("‚úì Routes file already exists. Skipping download.\n")
}
```

### Load Routes Data

```{r}
# Define column names for routes
routes_column <- c("Airline","Airline_ID", "Source_airport", "Source_airport_ID","Destination_airport","Destination_airport_ID", "Codeshare", "Stops", "Equipment")

# Read the routes file
routes <- read_delim(
  "data/routes.dat", 
  delim = ",",
  col_names = routes_column,
  show_col_types = FALSE
)

# Save a copy as CSV
write_csv(routes, "output/routes.csv")

cat("‚úì Loaded", nrow(routes), "routes from the database\n")
```

### Load Airports Data

```{r}
# Define column names for airports
airports_column <- c(
  "Airport_ID", "Name", "City", "Country", "IATA", "ICAO",
  "Latitude", "Longitude", "Altitude", "Timezone", "DST",
  "Tz_database_timezone", "Type", "Source"
)

# Read the airports file
airports <- read_delim(
  "data/airports.dat", 
  delim = ",",
  col_names = airports_column,
  show_col_types = FALSE
)

# Save a copy as CSV
write_csv(airports, "output/airports.csv")

cat("‚úì Loaded", nrow(airports), "airports from the database\n")
cat("\nüìç Sample airports:\n")
print(head(airports %>% select(Name, City, Country, IATA, Latitude, Longitude), 5))
```

### Convert Airports to Spatial Format

```{r}
# Convert to spatial object
airports_sf <- airports %>%
  mutate(
    Latitude = as.numeric(Latitude),
    Longitude = as.numeric(Longitude)
  ) %>%
  filter(!is.na(Latitude), !is.na(Longitude)) %>%
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326, remove = FALSE)

# Transform to Equal Earth projection
airports_sf <- st_transform(airports_sf, crs = 8857)

# Save as shapefile
st_write(airports_sf, "output/airports.shp", append = FALSE, quiet = TRUE)

cat("‚úì Created spatial object with", nrow(airports_sf), "airports\n")
```

---

## üõ´ Step 2: Create Geodetic (Curved) Route Lines

### Clean Routes Data

```{r}
# Clean the routes data
routes_clean <- routes %>%
  mutate(
    Source_airport = str_trim(Source_airport),
    Destination_airport = str_trim(Destination_airport)
  ) %>%
  filter(
    !is.na(Source_airport), !is.na(Destination_airport),
    Source_airport != "", Destination_airport != "",
    str_detect(Source_airport, "^[A-Z]{3}$"),
    str_detect(Destination_airport, "^[A-Z]{3}$")
  )

cat("‚úì", nrow(routes_clean), "valid routes (from", nrow(routes), "total)\n")
```

### Join Airport Coordinates to Routes

```{r}
# Create lookup table
airports_lookup <- airports %>%
  mutate(
    IATA = str_trim(IATA),
    Latitude = as.numeric(Latitude),
    Longitude = as.numeric(Longitude)
  ) %>%
  filter(
    !is.na(IATA), IATA != "",
    str_detect(IATA, "^[A-Z]{3}$"),
    !is.na(Latitude), !is.na(Longitude)
  ) %>%
  distinct(IATA, .keep_all = TRUE) %>%
  select(IATA, Latitude, Longitude)

# Join coordinates to routes
routes_joined <- routes_clean %>%
  left_join(
    airports_lookup %>% rename(src_lat = Latitude, src_lon = Longitude),
    by = c("Source_airport" = "IATA")
  ) %>%
  left_join(
    airports_lookup %>% rename(dst_lat = Latitude, dst_lon = Longitude),
    by = c("Destination_airport" = "IATA")
  ) %>%
  filter(
    !is.na(src_lon), !is.na(src_lat),
    !is.na(dst_lon), !is.na(dst_lat)
  )

write_csv(routes_joined, "output/routes_inc_locations.csv")
cat("‚úì Saved routes with coordinates:", nrow(routes_joined), "routes\n")
```

### Create Curved Route Lines

```{r}
# Create geodetic lines
routes_geodetic_list <- list()

cat("üîÑ Creating geodetically accurate curved routes...\n")
cat("‚è±Ô∏è This may take 2-3 minutes for", nrow(routes_joined), "routes\n\n")

for (i in 1:nrow(routes_joined)) {
  start_point <- c(routes_joined$src_lon[i], routes_joined$src_lat[i])
  end_point <- c(routes_joined$dst_lon[i], routes_joined$dst_lat[i])
  
  gc_line <- gcIntermediate(
    start_point, 
    end_point, 
    n = 100,
    addStartEnd = TRUE
  )
  
  routes_geodetic_list[[i]] <- st_linestring(gc_line)
  
  if (i %% 5000 == 0) {
    cat("  ‚úì Processed", i, "of", nrow(routes_joined), "routes\n")
  }
}

cat("\n‚úì Geodetic route creation complete!\n")
```

### Convert to Spatial Object

```{r}
# Convert to spatial data frame
routes_geodetic_sf <- st_sf(
  routes_joined,
  geometry = st_sfc(routes_geodetic_list, crs = 4326)
)

# Transform to Equal Earth projection
routes_geodetic_sf <- st_transform(routes_geodetic_sf, crs = 8857)

# Save as shapefile
st_write(routes_geodetic_sf, "output/routes_geodesic.shp", delete_dsn = TRUE, quiet = TRUE)

cat("‚úì Created", nrow(routes_geodetic_sf), "geodetic route lines\n")
```

---

## üî∂ Step 3: Create Hexagonal Grid

### Load World Boundaries

```{r}
# Get world boundaries
world <- ne_countries(scale = "medium", returnclass = "sf") %>%
  st_transform(8857) %>%
  st_make_valid()

cat("‚úì Loaded world boundaries\n")
```

### Create Hexagon Grid

```{r}
# Create hexagonal grid
hexgrid <- st_make_grid(
  world,
  cellsize = 1e5,  # 100km
  what = "polygons",
  square = FALSE
) %>%
  st_as_sf() %>%
  mutate(id = row_number())

cat("‚úì Created hexagon grid with", nrow(hexgrid), "hexagons\n")
```

### Filter to Land Hexagons

```{r}
# Keep only hexagons over land
land_union <- st_union(world)
hexgrid_world <- hexgrid[lengths(st_intersects(hexgrid, land_union)) > 0, ]

cat("‚úì Filtered to", nrow(hexgrid_world), "hexagons over land\n")

# Save hexgrid
st_write(hexgrid_world, "output/world_hexgrid.shp", delete_layer = TRUE, quiet = TRUE)
```

---

## üî¢ Step 4: Count Routes per Hexagon

### Calculate Intersections

```{r}
cat("üîç Calculating route-hexagon intersections...\n")
cat("‚è±Ô∏è This may take 1-2 minutes\n\n")

# Find intersections
intersections_geodetic <- st_intersects(hexgrid_world, routes_geodetic_sf)

cat("‚úì Intersection calculation complete\n")
```

### Add Route Counts

```{r}
# Add counts to hexagons
hexgrid_world_geodetic_cnt <- hexgrid_world %>%
  mutate(nm_rts = lengths(intersections_geodetic))

# Save result
st_write(
  hexgrid_world_geodetic_cnt, 
  "output/world_hexgrid_geodetic_count.shp", 
  delete_layer = TRUE, 
  quiet = TRUE
)

cat("‚úì Added route counts to hexagons\n\n")

# Summary statistics
cat("üìä Route Count Statistics:\n")
cat("========================\n")
summary(hexgrid_world_geodetic_cnt$nm_rts)

cat("\nüìç Additional Insights:\n")
cat("- Hexagons with 0 routes:", sum(hexgrid_world_geodetic_cnt$nm_rts == 0), "\n")
cat("- Hexagons with 100+ routes:", sum(hexgrid_world_geodetic_cnt$nm_rts >= 100), "\n")
cat("- Maximum routes in one hexagon:", max(hexgrid_world_geodetic_cnt$nm_rts), "\n")
```

---

## üé® Step 5: Create Final Visualization

### Create Beautiful Flight Density Map

```{r}
# Create the map with grey background
map_geodetic <- ggplot() +
  
  # World boundaries
  geom_sf(
    data = world, 
    fill = "gray20",      # Dark grey landmass
    color = "gray40",     # Slightly lighter borders
    linewidth = 0.1
  ) +
  
  # Hexagonal grid with route counts
  geom_sf(
    data = hexgrid_world_geodetic_cnt, 
    aes(fill = nm_rts),
    color = NA,
    alpha = 0.85
  ) +
  
  # Color scale
  scale_fill_viridis_c(
    option = "plasma",
    name = "Number of\nFlight Routes",
    trans = "sqrt",
    breaks = c(0, 10, 50, 100, 250, 500, 1000, 2500),
    labels = comma,
    guide = guide_colorbar(
      barwidth = 15,
      barheight = 0.5,
      title.position = "top",
      title.hjust = 0.5
    )
  ) +
  
  # Labels
  labs(
    title = "Global Flight Route Density (Geodetic Routes)",
    subtitle = "Using geodetically accurate curved routes that follow Earth's curvature",
    caption = "Data: OpenFlights | Routes follow great circle paths"
  ) +
  
  # Theme with grey background
  theme_minimal() +
  theme(
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5, color = "white"),
    plot.subtitle = element_text(size = 12, hjust = 0.5, color = "gray70"),
    plot.caption = element_text(size = 8, color = "gray60", hjust = 1),
    legend.position = "bottom",
    legend.title = element_text(size = 10, face = "bold", color = "white"),
    legend.text = element_text(size = 8, color = "gray80"),
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    plot.background = element_rect(fill = "gray15", color = NA),   # Dark grey background
    panel.background = element_rect(fill = "gray15", color = NA)   # Dark grey panel
  ) +
  
  coord_sf(crs = 8857)

# Display the map
print(map_geodetic)
```

### Save High-Quality Outputs

```{r}
# Save as PNG with grey background
ggsave(
  "output/flight_route_density_map_geodetic.png",
  plot = map_geodetic,
  width = 16,
  height = 10,
  dpi = 300,
  bg = "gray15"
)

# Save as PDF
ggsave(
  "output/flight_route_density_map_geodetic_print.pdf",
  plot = map_geodetic,
  width = 16,
  height = 10,
  device = "pdf"
)

cat("‚úì Maps saved successfully!\n")
cat("  - flight_route_density_map_geodetic.png (300 DPI)\n")
cat("  - flight_route_density_map_geodetic_print.pdf\n")
```

---

## üéâ Success!

You've successfully created a professional flight route density visualization! 

### What the Map Shows

**Bright colors (yellow/pink)** indicate:
- High concentration of flight routes
- Major aviation hubs
- Well-connected regions

**Dark colors (purple/blue)** indicate:
- Few flight routes
- Remote or less connected regions

---

## üìù Session Information

```{r}
sessionInfo()
```