---
title: "Global Flight Route Density Mapping"
author: "Nimesh Akalanka"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    toc-location: left
    code-fold: show
    code-tools: true
    theme: cosmo
    fig-width: 16
    fig-height: 10
    embed-resources: true
execute:
  warning: false
  message: false
---

## üéØ What You'll Create

By the end of this tutorial, you'll have a beautiful, professional map showing **where airplanes fly most frequently around the world**. Think of it like a heat map - brighter colors show busier flight routes!

**Perfect for**: Beginners in data visualization, geography students, aviation enthusiasts, or anyone wanting to learn R programming.

## üìã Overview

### What This Tutorial Does (In Simple Terms)

1. **Downloads real flight data** from the internet (airports and routes)
2. **Processes the data** to connect airports with flight paths
3. **Creates a hexagon grid** over the world map (like a honeycomb)
4. **Counts how many flights** pass through each hexagon
5. **Makes a colorful map** showing flight density

### Types of Routes We'll Create

**Straight Routes** üîπ: Direct lines between airports (like drawing with a ruler on a flat map)

**Curved Routes** üåê: Realistic paths following Earth's spherical surface (how planes actually fly!)

::: {.callout-note icon="üí°"}
## Why Curved Routes Matter
Imagine you're flying from New York to Tokyo. On a flat map, the shortest path looks like it goes straight across the Pacific Ocean. But Earth is round! The actual shortest path curves up through Alaska. That's what geodetic (curved) routes show.
:::

---

### Install Required R Packages

Run this code **once** to install everything:

```{r}
#| eval: false
# Install all required packages
install.packages(c(
  "readr", "dplyr", "tidyr", "stringr", "sf", "ggplot2", 
  "viridis", "scales", "rnaturalearth", 
  "rnaturalearthdata", "geosphere", "tmap", "purrr"
))
```

::: {.callout-tip icon="‚è±Ô∏è"}
## Installation Time
This may take 5-10 minutes depending on your internet speed. Be patient!
:::

### Load Libraries

After installing packages once, you need to "load" them each time you start R:

```{r}
# Load all libraries we'll use
library(readr)
library(dplyr)
library(tidyr)
library(stringr)    
library(sf)      
library(ggplot2)       
library(viridis)      
library(scales)      
library(rnaturalearth) 
library(geosphere)     
library(tmap)
library(purrr)     

cat("‚úì All libraries loaded successfully!\n")
```

---

## üìÇ Step 1: Download and Prepare Airport Data

### Create Folder Structure

```{r}
# Create two folders: one for outputs, one for raw data
folders <- c("output", "data")
sapply(folders, dir.create, showWarnings = FALSE, recursive = TRUE)

cat("‚úì Folders created successfully!\n")
```

### Download Airport Data

Download the airport location data from the jpatokal/openflights repository:

```{r}
# Check if we already have the airports file
if (!file.exists("data/airports.dat")) {
  cat("üì• Downloading airports.dat...\n")
  
  download.file(
    url = "https://raw.githubusercontent.com/jpatokal/openflights/master/data/airports.dat",
    destfile = "data/airports.dat",
    mode = "wb"
  )
  cat("‚úì Airports downloaded!\n")
} else {
  cat("‚úì Airports file already exists. Skipping download.\n")
}
```

### Download Routes Data

Download the routes data from the jpatokal/openflights repository:

```{r}
# Check if we already have the routes file
if (!file.exists("data/routes.dat")) {
  cat("üì• Downloading routes.dat...\n")
  
  download.file(
    url = "https://raw.githubusercontent.com/jpatokal/openflights/master/data/routes.dat",
    destfile = "data/routes.dat",
    mode = "wb"
  )
  cat("‚úì Routes downloaded!\n")
} else {
  cat("‚úì Routes file already exists. Skipping download.\n")
}
```

### Load World Boundaries

Load world boundaries from the rnaturalearth library:

```{r}
# Get world boundaries
world <- ne_countries(scale = "medium", returnclass = "sf") %>%
  st_transform(8857) %>%  # Transform to Equal Earth projection
  st_make_valid()         # Ensure geometries are valid

cat("‚úì Loaded world boundaries\n")
```

::: {.callout-note}
## Coordinate Reference System (CRS)
We use EPSG:8857 (Equal Earth projection) which is excellent for global maps. It balances shape, area, and distance distortion across the entire globe.
:::

### Load Routes Data

```{r}
# Define column names for routes
routes_column <- c(
  "Airline", "Airline_ID", "Source_airport", "Source_airport_ID",
  "Destination_airport", "Destination_airport_ID", 
  "Codeshare", "Stops", "Equipment"
)

# Read the routes file
routes <- read_delim(
  "data/routes.dat", 
  delim = ",",
  col_names = routes_column,
  show_col_types = FALSE
)

# Save a copy as CSV
write_csv(routes, "output/routes.csv")

cat("‚úì Loaded", nrow(routes), "routes from the database\n")
```

### Load Airports Data

```{r}
# Define column names for airports
airports_column <- c(
  "Airport_ID", "Name", "City", "Country", "IATA", "ICAO",
  "Latitude", "Longitude", "Altitude", "Timezone", "DST",
  "Tz_database_timezone", "Type", "Source"
)

# Read the airports file
airports <- read_delim(
  "data/airports.dat", 
  delim = ",",
  col_names = airports_column,
  show_col_types = FALSE
)

# Save a copy as CSV
write_csv(airports, "output/airports.csv")

cat("‚úì Loaded", nrow(airports), "airports from the database\n")
cat("\nüìç Sample airports:\n")
print(head(airports %>% select(Name, City, Country, IATA, Latitude, Longitude), 5))
```

### Convert Airports to Spatial Format

Convert the airports dataframe to a spatial object:

::: {.callout-important}
## Data Requirements
The `Latitude` and `Longitude` fields must not contain missing values for proper conversion to spatial format.
:::

```{r}
# Convert to spatial object
airports_sf <- airports %>%
  mutate(
    Latitude = as.numeric(Latitude),
    Longitude = as.numeric(Longitude)
  ) %>%
  filter(!is.na(Latitude), !is.na(Longitude)) %>%
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326, remove = FALSE)

# Transform to Equal Earth projection
airports_sf <- st_transform(airports_sf, crs = 8857)

# Save as shapefile
st_write(airports_sf, "output/airports.shp", delete_dsn = TRUE, quiet = TRUE)

cat("‚úì Created spatial object with", nrow(airports_sf), "airports\n")
```

### Visualize Airport Locations

```{r}
# Create airport locations map
airports_map <- tm_shape(world) + 
  tm_polygons(
    col = "gray20", 
    border.col = NA,
    lwd = 0
  ) +  
  tm_shape(airports_sf) + 
  tm_dots(
    col = "#00B2D1",
    size = 0.1,
    alpha = 0.6,
    border.lwd = 0
  ) + 
  tm_layout(
    title = "GLOBAL AIRPORT LOCATIONS",
    title.size = 1.2,
    title.color = "gray15",
    title.position = c("center", "top"),
    title.fontface = "bold",
    bg.color = "gray90",
    frame = FALSE,
    legend.position = c("left", "bottom"),
    legend.bg.color = "#16213e",
    legend.bg.alpha = 0.85,
    legend.frame.color = "#0f3460",
    legend.frame.lwd = 2,
    legend.title.size = 1.1,
    legend.title.color = "#ffffff",
    legend.title.fontface = "bold",
    legend.text.size = 0.85,
    legend.text.color = "#e8e8e8",
    inner.margins = c(0.02, 0.02, 0.08, 0.02),
    outer.margins = c(0, 0, 0, 0),
    asp = 1.8,
    fontfamily = "sans"
  ) +
  tm_credits(
    text = "Source: jpatokal/openflights | Year: 2014 | Total Airports: 7,698", 
    position = c("center", "bottom"), 
    col = "gray40",
    size = 0.6
  )

# Save the map
tmap_save(airports_map, "output/01.airports_map.png", width = 18, height = 10,  dpi = 400)

# Display the map
airports_map
```

---

## üõ´ Step 2: Create Route Lines

### Clean Routes Data

Clean the routes data before joining with airports:

```{r}
# Clean the routes data
routes_clean <- routes %>%
  mutate(
    Source_airport = str_trim(Source_airport),
    Destination_airport = str_trim(Destination_airport)
  ) %>%
  filter(
    !is.na(Source_airport), !is.na(Destination_airport),
    Source_airport != "", Destination_airport != "",
    str_detect(Source_airport, "^[A-Z]{3}$"),
    str_detect(Destination_airport, "^[A-Z]{3}$")
  )

cat("‚úì", nrow(routes_clean), "valid routes (from", nrow(routes), "total)\n")
```

### Join Airport Coordinates to Routes

```{r}
# Create lookup table for airport coordinates
airports_lookup <- airports %>%
  mutate(
    IATA = str_trim(IATA),
    Latitude = as.numeric(Latitude),
    Longitude = as.numeric(Longitude)
  ) %>%
  filter(
    !is.na(IATA), IATA != "",
    str_detect(IATA, "^[A-Z]{3}$"),
    !is.na(Latitude), !is.na(Longitude)
  ) %>%
  distinct(IATA, .keep_all = TRUE) %>%
  select(IATA, Latitude, Longitude)

# Join coordinates to routes
routes_joined <- routes_clean %>%
  left_join(
    airports_lookup %>% rename(src_lat = Latitude, src_lon = Longitude),
    by = c("Source_airport" = "IATA")
  ) %>%
  left_join(
    airports_lookup %>% rename(dst_lat = Latitude, dst_lon = Longitude),
    by = c("Destination_airport" = "IATA")
  ) %>%
  filter(
    !is.na(src_lon), !is.na(src_lat),
    !is.na(dst_lon), !is.na(dst_lat)
  )

write_csv(routes_joined, "output/routes_inc_locations.csv")
cat("‚úì Saved routes with coordinates:", nrow(routes_joined), "routes\n")
```

### Count Airport Traffic

Count how many routes use each airport as source or destination:

```{r}
# Count source and destination airports
src_count <- routes_joined %>% count(Source_airport) %>% rename(IATA = Source_airport, src_count = n)

dst_count <- routes_joined %>% count(Destination_airport) %>% rename(IATA = Destination_airport, dst_count = n)

# Combine counts
airports_count <- full_join(src_count, dst_count, by = "IATA") %>%
  mutate(
    src_count = replace_na(src_count, 0),
    dst_count = replace_na(dst_count, 0),
    total = src_count + dst_count
  )

# Join with coordinates
airports_count <- left_join(airports_lookup, airports_count, by = "IATA")

# Convert to spatial object
airports_count_sf <- airports_count %>%
  filter(!is.na(Latitude), !is.na(Longitude)) %>%
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326, remove = FALSE) %>%
  st_transform(crs = 8857)

cat("‚úì Calculated airport traffic counts\n")
cat("üìä Top 5 busiest airports by route count:\n")
print(airports_count %>% arrange(desc(total)) %>% head(5) %>% select(IATA, total))
```


### Visualize Airport Traffic

```{r}
# Prepare the map
world_busiest_airports_map <- tm_shape(world, bbox = st_bbox(c(xmin = -180, xmax = 180, ymin = -90, ymax = 90), crs = st_crs(4326))) + 
  tm_polygons(
    col = "#525252", 
    border.col = "#252525",
    lwd = 0.1
  ) + 
  tm_shape(airports_count_sf) + 
  tm_dots(
    col = "total",        
    size = "total",         
    palette = "viridis",     
    style = "quantile",
    size.scale = tm_scale_continuous(values.scale = 1000),
    border.lwd = 0,                 
    alpha = 0.6,
    legend.reverse = TRUE,
    legend.col.show = TRUE,
    legend.size.show = FALSE,
    col.legend = tm_legend(title = "Total Flights")
  ) + 
  tm_layout(
    title = "WORLD'S BUSIEST AIRPORTS",
    title.size = 1.2,
    title.color = "#ffffff",
    title.position = c("center", "top"),
    title.fontface = "bold",
    bg.color = "#252525",
    frame = FALSE,
    legend.position = c("left", "bottom"),
    legend.bg.color = "#16213e",
    legend.bg.alpha = 0.85,
    legend.frame.color = "#0f3460",
    legend.frame.lwd = 2,
    legend.title.size = 1.1,
    legend.title.color = "#ffffff",
    legend.title.fontface = "bold",
    legend.text.size = 0.85,
    legend.text.color = "#e8e8e8",
    inner.margins = c(0.02, 0.02, 0.08, 0.02),
    outer.margins = c(0, 0, 0, 0),
    asp = 1.8,
    fontfamily = "sans"
  ) +
  tm_credits(
    text = "Source: jpatokal/openflights | Year: 2014", 
    position = c("center", "bottom"), 
    col = "gray40",
    size = 0.6
  )

# Save the map
tmap_save(world_busiest_airports_map, "output/02.world_busiest_airports_map.png", width = 18, height = 10,  dpi = 400)

# Display the map
world_busiest_airports_map
```

### Create Straight (Euclidean) Route Lines

Create direct line connections between airports:

```{r}
# Create straight line geometries
routes_lines_sf <- routes_joined %>%
  mutate(
    geometry = mapply(
      function(x1, y1, x2, y2) {
        st_linestring(matrix(c(x1, y1, x2, y2), ncol = 2, byrow = TRUE))
      },
      src_lon, src_lat, dst_lon, dst_lat,
      SIMPLIFY = FALSE
    ) %>% st_sfc(crs = 4326)
  ) %>%
  st_as_sf() %>%
  st_transform(crs = 8857)

# Save as shapefile
st_write(routes_lines_sf, "output/routes_lines.shp", delete_dsn = TRUE, quiet = TRUE)

cat("‚úì Created", nrow(routes_lines_sf), "straight route lines\n")
```

### Visualize Straight Routes

```{r}
# Create map with tmap
routes_lines_map <- tm_shape(world) + 
  tm_polygons(
    col = "#525252", 
    border.col = "#252525",
    lwd = 0.1
  ) +  
  tm_shape(routes_lines_sf) + 
  tm_lines(
    col = "#ffffff",
    lwd = 0.1, 
    alpha = 0.08
  ) +
  tm_shape(airports_count_sf) + 
  tm_dots(
    col = "total",        
    size = "total",         
    palette = "viridis",     
    style = "quantile",
    size.scale = tm_scale_continuous(values.scale = 10),
    border.lwd = 0,                 
    alpha = 0.6,
    legend.reverse = TRUE,
    legend.col.show = TRUE,
    legend.size.show = FALSE,
    col.legend = tm_legend(title = "Total Flights")
  ) +   
  tm_layout(
    title = "GLOBAL AIRPLANE ROUTES (EUCLIDEAN DISTANCE)",
    title.size = 1.2,
    title.color = "#ffffff",
    title.position = c("center", "top"),
    title.fontface = "bold",
    bg.color = "#252525",
    frame = FALSE,
    legend.position = c("left", "bottom"),
    legend.bg.color = "#16213e",
    legend.bg.alpha = 0.85,
    legend.frame.color = "#0f3460",
    legend.frame.lwd = 2,
    legend.title.size = 1.1,
    legend.title.color = "#ffffff",
    legend.title.fontface = "bold",
    legend.text.size = 0.85,
    legend.text.color = "#e8e8e8",
    inner.margins = c(0.02, 0.02, 0.08, 0.02),
    outer.margins = c(0, 0, 0, 0),
    asp = 1.8,
    fontfamily = "sans"
  ) +
  tm_credits(
    text = "Source: jpatokal/openflights | Year: 2014", 
    position = c("center", "bottom"), 
    col = "gray80",
    size = 0.6
  )

# Save the map
tmap_save(routes_lines_map, "output/03.routes_euclidean_map.png", width = 18, height = 10,  dpi = 400)

# Display the map
routes_lines_map
```

::: {.callout-warning}
## Why Straight Lines Are Misleading
While straight lines look simple on a flat map, they don't represent how planes actually fly. Earth's curvature means the shortest distance between two points is a curve, not a straight line!
:::

### Create Curved (Geodetic) Route Lines

Create realistic curved routes following Earth's surface:

```{r}
# Convert linestring to curves
routes_geodetic_sf <- routes_joined %>%
  mutate(
    geometry = pmap(
      list(src_lon, src_lat, dst_lon, dst_lat),
      function(lon1, lat1, lon2, lat2) {
        # Calculate great circle intermediate points
        gc_points <- gcIntermediate(
          c(lon1, lat1), 
          c(lon2, lat2), 
          n = 100,  # Number of intermediate points
          addStartEnd = TRUE
        )
        st_linestring(gc_points)
      }
    ) %>% st_sfc(crs = 4326)
  ) %>%
  st_as_sf() %>%
  st_transform(crs = 8857)

# Save as shapefile
st_write(routes_geodetic_sf, "output/routes_geodetic_lines.shp", delete_dsn = TRUE, quiet = TRUE)

cat("‚úì Created", nrow(routes_geodetic_sf), "geodetic routes\n")
```

::: {.callout-tip}
## How Geodetic Lines Work
The `gcIntermediate()` function calculates the shortest path between two points on a sphere (Earth). By adding 100 intermediate points, we get a smooth curve that accurately represents the flight path.
:::

### Visualize Geodetic Routes

```{r}
# Create map with tmap
routes_geodetic_map <- tm_shape(world) + 
  tm_polygons(
    col = "#525252", 
    border.col = "#252525", 
    lwd = 0
  ) +  
  tm_shape(routes_geodetic_sf) + 
  tm_lines(
    col = "#ffffff", 
    lwd = 0.1, 
    alpha = 0.08
  ) + 
  tm_shape(airports_count_sf) + 
  tm_dots(
    col = "total",        
    size = "total",         
    palette = "viridis",     
    style = "quantile",
    size.scale = tm_scale_continuous(values.scale = 10),
    border.lwd = 0,                 
    alpha = 0.6,
    legend.reverse = TRUE,
    legend.col.show = TRUE,
    legend.size.show = FALSE,
    col.legend = tm_legend(title = "Total Flights")
  ) + 
  tm_layout(
    title = "GLOBAL AIRPLANE ROUTES (GEODESIC DISTANCE)",
    title.size = 0.9,
    title.color = "#ffffff",
    title.position = c("center", "top"),
    title.fontface = "bold",
    bg.color = "#252525",
    frame = FALSE,
    legend.position = c("left", "bottom"),
    legend.bg.color = "#16213e",
    legend.bg.alpha = 0.85,
    legend.frame.color = "#0f3460",
    legend.frame.lwd = 2,
    legend.title.size = 1.1,
    legend.title.color = "#ffffff",
    legend.title.fontface = "bold",
    legend.text.size = 0.85,
    legend.text.color = "#e8e8e8",
    inner.margins = c(0.02, 0.02, 0.08, 0.02),
    outer.margins = c(0, 0, 0, 0),
    asp = 1.8,
    fontfamily = "sans"
  ) +
  tm_credits(
    text = "Source: jpatokal/openflights | Year: 2014", 
    position = c("center", "bottom"), 
    col = "#a0a3ad", 
    size = 0.7
  )

# Save the map
tmap_save(routes_geodetic_map, "output/04.routes_geodetic_map.png", width = 18, height = 10,  dpi = 400)

# Display the map
routes_geodetic_map
```

---

## üî∂ Step 3: Create Hexagonal Grid

### Generate Hexagon Grid

- In this study, a hexagonal grid overlay was created for the world. 
- The grid has a cell size of 300 km, specified as `cellsize = 3e5` (300,000 meters or 300 km). 
- This grid provides a spatial framework for analyzing the global distribution of flight routes and other spatial data.
- This type of hexagonal or square grid overlay is particularly useful when the data density is high, and traditional visualization techniques are unable to accurately depict the true variation in the data. By dividing the space into uniform grid cells, it becomes easier to identify patterns and trends, especially in areas with complex or dense data.

```{r}
# Create hexagonal grid
hexgrid <- st_make_grid(
  world,
  cellsize = 3e5,
  what = "polygons",
  square = FALSE   # FALSE creates hexagons
) %>%
  st_as_sf() %>%
  mutate(id = row_number())

cat("‚úì Created hexagon grid with", nrow(hexgrid), "hexagons\n")
```

::: {.callout-note}
## Why Hexagons?
Hexagons are ideal for spatial analysis because:

- Each hexagon touches 6 neighbors (more than squares)
- They minimize edge effects and sampling bias
- They're visually appealing and easy to interpret
:::

### Filter to Land Hexagons

Keep only hexagons that intersect with land:

```{r}
# Union all countries into single geometry
land_union <- st_union(world)

# Keep hexagons that intersect land
hexgrid_world <- hexgrid[lengths(st_intersects(hexgrid, land_union)) > 0, ]

cat("‚úì Filtered to", nrow(hexgrid_world), "hexagons over land\n")

# Save hexgrid
st_write(hexgrid_world, "output/world_hexgrid.shp", delete_layer = TRUE, quiet = TRUE)
```

---

## üî¢ Step 4: Count Routes per Hexagon

### Calculate Route-Hexagon Intersections

Count how many routes pass through each hexagon:

```{r}
cat("üîç Calculating route-hexagon intersections...\n")
cat("‚è±Ô∏è This may take 1-2 minutes for", nrow(routes_geodetic_sf), "routes\n\n")

# Find which routes intersect each hexagon
intersections_geodetic <- st_intersects(hexgrid_world, routes_geodetic_sf)

cat("‚úì Intersection calculation complete\n")
```

### Add Route Counts to Hexagons

```{r}
# Count routes per hexagon
hexgrid_world_geodetic_cnt <- hexgrid_world %>% mutate(nm_rts = lengths(intersections_geodetic))

# Save result
st_write(hexgrid_world_geodetic_cnt, "output/world_hexgrid_geodetic_count.shp", delete_layer = TRUE, quiet = TRUE)

cat("‚úì Added route counts to hexagons\n\n")

# Summary statistics
cat("üìä Route Count Statistics:\n")
summary_stats <- summary(hexgrid_world_geodetic_cnt$nm_rts)
print(summary_stats)

# Additional insights
cat("\nüìç Key Insights:\n")
cat("‚Ä¢ Hexagons with routes:", sum(hexgrid_world_geodetic_cnt$nm_rts > 0), "\n")
cat("‚Ä¢ Hexagons with 100+ routes:", sum(hexgrid_world_geodetic_cnt$nm_rts >= 100), "\n")
cat("‚Ä¢ Maximum routes in a hexagon:", max(hexgrid_world_geodetic_cnt$nm_rts), "\n")
```

---

## üé® Step 5: Create Final Visualization

### Create Flight Density Heat Map

```{r}
# Create the map using tmap
map_geodetic <- tm_shape(world) +
  tm_polygons(
    col = "#1a1a2e",
    border.col = "#0f3460",
    lwd = 0.3,
    alpha = 0.6
  ) +
  tm_shape(hexgrid_world_geodetic_cnt) +
  tm_polygons(
    col = "nm_rts",
    palette = c("#440154", "#31688e", "#35b779", "#fde724"), 
    style = "fixed",
    alpha = 0.9,
    border.col = "#0a0e27",
    lwd = 2,
    title = "Flight Routes",
    breaks = c(0, 10, 50, 100, 250, 500, 1000, 2500, max(hexgrid_world_geodetic_cnt$nm_rts)),
    labels = c("0-10", "10-50", "50-100", "100-250", "250-500", "500-1000", "1000-2500", paste0(">2500")),
    legend.reverse = TRUE,
    legend.format = list(text.separator = " ")
  ) +
  tm_layout(
    title = "Global Flight Route Density",
    title.size = 1.4,
    title.color = "#ffffff",
    title.position = c("center", "top"),
    title.fontface = "bold",
    bg.color = "#0a0e27",
    frame = FALSE,
    legend.position = c("left", "bottom"),
    legend.bg.color = "#16213e",
    legend.bg.alpha = 0.85,
    legend.frame.color = "#0f3460",
    legend.frame.lwd = 2,
    legend.title.size = 1.1,
    legend.title.color = "#ffffff",
    legend.title.fontface = "bold",
    legend.text.size = 0.85,
    legend.text.color = "#e8e8e8",
    inner.margins = c(0.02, 0.02, 0.08, 0.02),
    outer.margins = c(0, 0, 0, 0),
    asp = 1.8,
    fontfamily = "sans"
  ) +
  tm_credits(
    text = "Data: OpenFlights (2014) | Year: 2014", 
    position = c("center", "bottom"), 
    col = "#94a3b8", 
    size = 0.75,
    fontface = "italic"
  ) +
  tm_compass(
    type = "arrow",
    position = c("right", "top"),
    size = 2,
    color.dark = "#fde724",
    color.light = "#ffffff",
    text.size = 0.6,
    text.color = "#ffffff"
  ) +
  tm_scale_bar(
    position = c("right", "bottom"),
    text.size = 0.6,
    text.color = "#ffffff",
    color.dark = "#ffffff",
    color.light = "#94a3b8",
    breaks = c(0, 2000, 4000, 6000)
  )

# Save the enhanced map
tmap_save(map_geodetic,"output/05.Hexagon_Grid_flight_density_map.png",width = 18,height = 10,dpi = 400)

# Display the map
map_geodetic
```

::: {.callout-tip icon="üé®"}
## Color Scale Interpretation

- **Dark purple/blue (0-50 routes)**: Remote or less-connected regions
- **Pink/orange (50-250 routes)**: Moderate air traffic
- **Bright yellow (250+ routes)**: Major aviation corridors and hubs
:::

---

## üéâ Success!

Congratulations! You've successfully created a professional flight route density visualization! 

### What You've Learned

‚úÖ How to download and process geospatial data  
‚úÖ The difference between Euclidean and geodetic distances  
‚úÖ How to create and work with hexagonal grids  
‚úÖ How to perform spatial intersections  
‚úÖ How to create professional data visualizations with tmap

### Key Insights from Your Map

**Bright colors (yellow/pink)** indicate:

- High concentration of flight routes
- Major aviation hubs (e.g., Europe, North America, East Asia)
- Well-connected regions with frequent air traffic

**Dark colors (purple/blue)** indicate:

- Few flight routes
- Remote or less connected regions
- Lower air traffic density

### Next Steps

Want to take this further? Try:

1. **Filter by airline or region**: Analyze specific airline networks
2. **Time-based analysis**: Compare route patterns across years
3. **Network analysis**: Calculate connectivity metrics between airports
4. **Interactive maps**: Use `leaflet` to create web-based interactive versions

---

## üìö Additional Resources

- [sf package documentation](https://r-spatial.github.io/sf/)
- [tmap documentation](https://r-tmap.github.io/tmap/)
- [OpenFlights database](https://openflights.org/data.html)
- [Spatial data science book](https://r-spatial.org/book/)

---

## üìù Session Information

```{r}
sessionInfo()
```

---

## üíæ Files Created

This tutorial creates the following files in the `output` folder:

| File | Description |
|------|-------------|
| `routes.csv` | Raw routes data |
| `airports.csv` | Raw airports data |
| `routes_inc_locations.csv` | Routes with coordinate information |
| `airports.shp` | Airports as spatial points |
| `routes_lines.shp` | Straight (Euclidean) route lines |
| `routes_geodetic_lines.shp` | Curved (geodetic) route lines |
| `world_hexgrid.shp` | Hexagonal grid over land |
| `world_hexgrid_geodetic_count.shp` | Hexagons with route counts |
| `01.airports_map.png` | Map showing all airport locations |
| `02.world_busiest_airports_map.png` | Map of busiest airports by route count |
| `03.routes_euclidean_map.png` | Map with straight routes and airports |
| `04.routes_geodetic_map.png` | Map with curved routes and airports |
| `05.Hexagon_Grid_flight_density_map.png` | Final heat map visualization |

---

**End of Tutorial** ‚úàÔ∏èüåç