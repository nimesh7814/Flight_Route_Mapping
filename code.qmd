---
title: "Global Flight Route Density Mapping"
author: "Nimesh Akalanka"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    toc-location: left
    code-fold: show
    code-tools: true
    theme: cosmo
    fig-width: 16
    fig-height: 10
    embed-resources: true
execute:
  warning: false
  message: false
---

## Overview

This document walks you through creating a stunning visualization of global flight route density using R. You'll download real flight data, process it spatially, and create a hexagonal heat map showing where flight routes are most concentrated around the world.

**Final Output**: A professional map showing flight route density across the globe using hexagonal grids with color gradients.

## Prerequisites

### Required R Packages

```{r}
# install.packages(c("readr","dplyr","stringr","sf","ggplot2","viridis","scales","rnaturalearth"))
```

### Load Libraries

```{r}

library(readr)
library(dplyr)
library(stringr)
library(sf)
library(ggplot2)
library(viridis)
library(scales)
library(rnaturalearth)
```

## Step 1: Download and Prepare Airport Data

### What This Does

Downloads two datasets from OpenFlights: airports (locations) and routes (connections between airports). The code creates a folder structure, downloads the data, and converts airports into a spatial format.

```{r}
# Create required directories
folders <- c("output", "data")
sapply(folders, dir.create, showWarnings = FALSE, recursive = TRUE)

# Download data only if not already present
if (!file.exists("data/airports.dat")) {
  cat("airports.dat is downloading to the data folder\n")
  download.file(
    "https://raw.githubusercontent.com/jpatokal/openflights/master/data/airports.dat",
    "data/airports.dat",
    mode = "wb"
  )
}

if (!file.exists("data/routes.dat")) {
  cat("routes.dat is downloading to the data folder\n")
  download.file(
    "https://raw.githubusercontent.com/jpatokal/openflights/master/data/routes.dat",
    "data/routes.dat",
    mode = "wb"
  )
}
```

### Load Routes Data

```{r}
# Load the routes data
routes_path <- "data/routes.dat"
routes_column <- c(
    "Airline",
    "Airline_ID",
    "Source_airport",
    "Source_airport_ID",
    "Destination_airport",
    "Destination_airport_ID",
    "Codeshare",
    "Stops",
    "Equipment"
)

routes <- read_delim(routes_path, delim = ",", col_names = routes_column, 
                     show_col_types = FALSE)
write_csv(routes, "output/routes.csv")

cat("Loaded", nrow(routes), "routes\n")
```

### Load and Process Airports Data

```{r}
# Load the airports data
airports_path <- "data/airports.dat"
airports_column <- c(
    "Airport_ID",
    "Name",
    "City",
    "Country",
    "IATA",
    "ICAO",
    "Latitude",
    "Longitude",
    "Altitude",
    "Timezone",
    "DST",
    "Tz_database_timezone",
    "Type",
    "Source"
)

airports <- read_delim(airports_path, delim = ",", col_names = airports_column, 
                       show_col_types = FALSE)
write_csv(airports, "output/airports.csv")

cat("Loaded", nrow(airports), "airports\n")
```

### Convert to Spatial Format

```{r}
# Convert the data frame to sf object using Latitude and Longitude
airports_sf <- airports %>%
  mutate(Latitude = as.numeric(Latitude), Longitude = as.numeric(Longitude)) %>%
  filter(!is.na(Latitude), !is.na(Longitude)) %>%
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326, remove = FALSE)

# Transform to projected coordinate system (Equal Earth projection)
airports_sf <- st_transform(airports_sf, crs = 8857)

# Save as shapefile
st_write(airports_sf, "output/airports.shp", append = FALSE, quiet = TRUE)

cat("Created spatial object with", nrow(airports_sf), "airports\n")
```

::: {.callout-note}
**CRS 4326**: Standard geographic coordinate system (latitude/longitude)  
**CRS 8857**: Equal Earth projection, good for world maps with minimal distortion
:::

## Step 2: Create Route Lines

### What This Does

Connects each source airport to its destination airport with a line, creating a spatial representation of every flight route.

### Clean Routes Data

```{r}
# Clean routes using strict IATA (3 capital letters only)
routes_clean <- routes %>%
  mutate(
    Source_airport      = str_trim(Source_airport),
    Destination_airport = str_trim(Destination_airport)
  ) %>%
  filter(
    !is.na(Source_airport), !is.na(Destination_airport),
    Source_airport != "", Destination_airport != "",
    str_detect(Source_airport, "^[A-Z]{3}$"),
    str_detect(Destination_airport, "^[A-Z]{3}$")
  )

# Print the status of the routes cleaning
if (nrow(routes) == nrow(routes_clean)) {
  cat("\nAll", nrow(routes), "entries are in correct order.\n\n")
} else {
  removed <- nrow(routes) - nrow(routes_clean)
  cat(removed, "records were removed.", nrow(routes_clean), 
      "valid entries remain out of", nrow(routes), "total records.\n")
}
```

### Join Airport Coordinates

```{r}
# Get the location information for both Source and Destination airports
airports_lookup <- airports %>%
  mutate(
    IATA = str_trim(IATA),
    Latitude  = as.numeric(Latitude),
    Longitude = as.numeric(Longitude)
  ) %>%
  filter(
    !is.na(IATA), IATA != "",
    str_detect(IATA, "^[A-Z]{3}$"),
    !is.na(Latitude), !is.na(Longitude)
  ) %>%
  distinct(IATA, .keep_all = TRUE) %>%
  select(IATA, Latitude, Longitude)

# Join routes with airport coordinates
routes_joined <- routes_clean %>%
  left_join(
    airports_lookup %>% rename(src_lat = Latitude, src_lon = Longitude),
    by = c("Source_airport" = "IATA")
  ) %>%
  left_join(
    airports_lookup %>% rename(dst_lat = Latitude, dst_lon = Longitude),
    by = c("Destination_airport" = "IATA")
  ) %>%
  filter(
    !is.na(src_lon), !is.na(src_lat),
    !is.na(dst_lon), !is.na(dst_lat)
  )

write_csv(routes_joined, "output/routes_inc_locations.csv")
cat("\nSaved routes with coordinates:", nrow(routes_joined), "routes\n")
```

### Create Line Geometries

```{r}
# Create the line geometries
routes_lines_sf <- routes_joined %>%
  mutate(
    geometry = mapply(function(x1, y1, x2, y2) {
      st_linestring(matrix(c(x1, y1, x2, y2), ncol = 2, byrow = TRUE))
    },
    src_lon, src_lat, dst_lon, dst_lat,
    SIMPLIFY = FALSE) |> st_sfc(crs = 4326)
  ) %>%
  st_as_sf()

# Transform to projected coordinate system
routes_lines_sf <- st_transform(routes_lines_sf, crs = 8857)

# Save the resulting line geometries to shapefile
st_write(routes_lines_sf, "output/routes_lines.shp", delete_dsn = TRUE, quiet = TRUE)

cat("\nCreated", nrow(routes_lines_sf), "valid route lines.\n")
```

## Step 3: Create Hexagonal Grid

Creates a honeycomb pattern of hexagons covering Earth's landmasses. Each hexagon is approximately 100km across.

```{r}
# Get world boundaries from rnaturalearth
world <- ne_countries(scale = "small", returnclass = "sf") %>%
  st_transform(8857) %>%
  st_make_valid()

# Create hex grid over the world's bounding box
hexgrid <- st_make_grid(world, cellsize = 1e5, what = "polygons", square = FALSE) %>%
  st_as_sf() %>%
  mutate(id = row_number())

# Keep only hexes that intersect land
land_union <- st_union(world)
hexgrid_world <- hexgrid[st_intersects(hexgrid, land_union, sparse = FALSE), ]

# Preview the grid
plot(st_geometry(world), col = NA, border = "grey40")
plot(st_geometry(hexgrid_world), add = TRUE, border = "red")

# Save the hexagonal grid
st_write(hexgrid_world, "output/world_hexgrid.shp", delete_layer = TRUE, quiet = TRUE)

cat("Created", nrow(hexgrid_world), "hexagons\n")
```

::: {.callout-tip}
**Adjust hexagon size** by changing `cellsize`:
- `5e4` = 50km (more detail)
- `1e5` = 100km (default)
- `2e5` = 200km (simpler view)
:::

## Step 4: Count Routes per Hexagon

Performs a spatial analysis to count how many flight routes pass through each hexagon.

```{r}
#| label: count-intersections

# Perform spatial join to find which route lines intersect with each hex grid
intersections <- st_intersects(hexgrid_world, routes_lines_sf)

# Add the number of intersected routes for each hexagon
hexgrid_world_rt_cnt <- hexgrid_world %>%
  mutate(nm_rts = lengths(intersections))

# Save the updated shapefile to disk
st_write(hexgrid_world_rt_cnt, "output/world_hexgrid_int_count.shp", 
         delete_layer = TRUE, quiet = TRUE)

# Summary statistics
cat("\nRoute count statistics:\n")
summary(hexgrid_world_rt_cnt$nm_rts)
```

## Step 5: Create Final Visualization

Creates a beautiful, publication-quality map showing flight route density using color gradients.

```{r}
# Create the map
map <- ggplot() +
  # Add world boundaries as background
  geom_sf(data = world, fill = "gray95", color = "white", size = 0.1) +
  
  # Add hexagonal grid with route counts
  geom_sf(data = hexgrid_world_rt_cnt, 
          aes(fill = nm_rts), 
          color = NA,
          alpha = 0.8) +
  
  # Use viridis color scale
  scale_fill_viridis_c(
    option = "plasma",
    name = "Number of\nFlight Routes",
    trans = "sqrt",
    breaks = c(0, 10, 50, 100, 250, 500, 1000, 2500),
    labels = comma,
    guide = guide_colorbar(
      barwidth = 15,
      barheight = 0.5,
      title.position = "top",
      title.hjust = 0.5
    )
  ) +
  
  # Add title and labels
  labs(
    title = "Global Flight Route Density",
    subtitle = "Hexagonal grid showing the number of flight routes intersecting each cell",
    caption = "Data: OpenFlights"
  ) +
  
  # Use a clean theme
  theme_minimal() +
  theme(
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5, color = "gray30"),
    plot.caption = element_text(size = 8, color = "gray50", hjust = 1),
    legend.position = "bottom",
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 8),
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    plot.background = element_rect(fill = "white", color = NA),
    panel.background = element_rect(fill = "white", color = NA)
  ) +
  
  # Set coordinate system
  coord_sf(crs = 8857)

# Display the map
print(map)
```

### Save High-Quality Outputs

```{r}
# Save high-quality version
ggsave(
  "output/flight_route_density_map.png",
  plot = map,
  width = 12,
  height = 8,
  dpi = 300,
  bg = "white"
)

# Save extra high-quality version for print
ggsave(
  "output/flight_route_density_map_print.pdf",
  plot = map,
  width = 12,
  height = 8,
  device = "pdf"
)

cat("Maps saved to output folder\n")
```

## Customization Options

### Alternative Color Schemes

```{r}
#| label: color-schemes
#| eval: false

# Try different color palettes
scale_fill_viridis_c(option = "magma")   # Black to pink/yellow
scale_fill_viridis_c(option = "viridis") # Purple to green/yellow
scale_fill_viridis_c(option = "inferno") # Black to orange/yellow
```

### What the Map Shows

- **Bright/warm colors**: High concentration of flight routes (major aviation hubs)
- **Dark/cool colors**: Few flight routes (remote or less connected regions)
- **Hot spots typically appear in**:
  - Eastern USA
  - Western Europe
  - Eastern Asia (China, Japan, Southeast Asia)
  - Middle East hub cities

## Credits and Data Sources

**Data Source**: [OpenFlights](https://openflights.org/)  
**License**: Open Database License (ODbL)  
**World Boundaries**: Natural Earth Data

## Session Information

```{r}
#| label: session-info

sessionInfo()
```